import streamlit as st
import asyncpg
import asyncio
import os
import pandas as pd

DATABASE_URL = os.getenv(
    "ENV_DB_URL",
    # "postgresql://postgres:postgres@host.docker.internal:5432/disaster_db"
    "postgresql+psycopg2://postgres:postgres@db:5432/disaster_db"
    
    )

# ---------------------------
# DB HELPERS
# ---------------------------

async def fetch_validations():
    query = """
        SELECT 
            v.id AS validation_id,
            v.report_id,
            v.flood_risk_level,
            v.risk_score,
            v.claim_validity,
            v.validation_notes,
            v.created_at,
            r.name,
            r.phone,
            r.category,
            r.message,
            r.latitude,
            r.longitude,
            r.created_at AS report_time
        FROM citizen_report_validations v
        LEFT JOIN citizen_reports r ON v.report_id = r.id
        ORDER BY v.created_at DESC;
    """

    conn = await asyncpg.connect(DATABASE_URL)
    rows = await conn.fetch(query)
    await conn.close()

    return [dict(row) for row in rows]


def get_validations():
    return asyncio.run(fetch_validations())


# ---------------------------
# STREAMLIT PAGE
# ---------------------------

st.title("üõ°Ô∏è AI Risk Validation Results")
st.subheader("Review environmental risk analysis generated by Agent 1")

st.markdown("---")

# Load data
validations = get_validations()

if len(validations) == 0:
    st.info("No validations have been generated yet.")
    st.stop()

# Display each validation in a card-style layout
for v in validations:
    with st.container(border=True):

        st.markdown(f"### üßæ Report ID: `{v['report_id']}`")
        st.write(f"üìÖ Validated At: {v['created_at']}")
        
        col1, col2 = st.columns(2)

        with col1:
            st.markdown("#### üë§ Reporter Details")
            st.write(f"**Name:** {v['name']}")
            st.write(f"**Phone:** {v['phone']}")
            st.write(f"**Category:** {v['category']}")
            st.write(f"**Message:** {v['message']}")

        with col2:
            st.markdown("#### üåç Location")
            st.write(f"Latitude: **{v['latitude']}**")
            st.write(f"Longitude: **{v['longitude']}**")
            st.write(f"Report Time: {v['report_time']}")

        st.markdown("---")

        # Risk Evaluation Section
        st.markdown("### üö® AI Flood Risk Assessment (Agent 1)")

        risk_color = {
            "low": "green",
            "moderate": "orange",
            "high": "red",
            "extreme": "darkred"
        }.get(v["flood_risk_level"], "gray")

        st.markdown(
            f"**Flood Risk Level:** "
            f"<span style='color:{risk_color}; font-weight:bold;'>{v['flood_risk_level'].upper()}</span>",
            unsafe_allow_html=True
        )

        st.write(f"**Risk Score:** {v['risk_score']} / 100")

        claim_color = "green" if v["claim_validity"] else "red"
        validity_text = "VALID" if v["claim_validity"] else "INVALID"

        st.markdown(
            f"**Claim Validity:** "
            f"<span style='color:{claim_color}; font-weight:bold;'>{validity_text}</span>",
            unsafe_allow_html=True
        )

        st.write("**Notes:**", v["validation_notes"])

        st.markdown("---")
